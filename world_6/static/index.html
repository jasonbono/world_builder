<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>World 6</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: system-ui, sans-serif; max-width: 900px; margin: 40px auto; padding: 0 20px; color: #1a1a1a; }
    h1 { font-size: 1.4em; margin-bottom: 16px; }
    #state { font-family: monospace; font-size: 1.3em; margin-bottom: 20px; color: #333; }
    .controls { display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 20px; }
    .group { border: 1px solid #ddd; border-radius: 6px; padding: 10px 14px; display: flex; align-items: center; gap: 8px; }
    button { padding: 6px 14px; border: 1px solid #aaa; border-radius: 4px; background: #f5f5f5; cursor: pointer; font-size: 0.9em; }
    button:hover { background: #e8e8e8; }
    input[type=number] { width: 60px; padding: 4px 6px; border: 1px solid #bbb; border-radius: 4px; }
    input[type=range] { width: 120px; }
    label { font-size: 0.9em; display: flex; align-items: center; gap: 6px; }
    canvas { border: 1px solid #e0e0e0; border-radius: 4px; display: block; margin-bottom: 10px; }
    #log { font-family: monospace; font-size: 0.8em; max-height: 160px; overflow-y: auto; border: 1px solid #eee; border-radius: 4px; padding: 8px; color: #555; white-space: pre; }
  </style>
</head>
<body>
  <h1>World 6</h1>
  <div id="state">--</div>
  <div class="controls">
    <div class="group">
      <button onclick="doReset()">Reset</button>
      <button onclick="doObserve()">Observe</button>
    </div>
    <div class="group">
      <label>A: <input type="range" id="aVal" min="-1" max="1" step="0.01" value="0">
      <span id="aLabel">0.00</span></label>
      <button onclick="doAct('A')">Act A</button>
    </div>
    <div class="group">
      <label>B: <input type="range" id="bVal" min="-2" max="2" step="0.1" value="0">
      <span id="bLabel">0.0</span></label>
      <button onclick="doAct('B')">Act B</button>
    </div>
    <div class="group">
      <label>Steps: <input type="number" id="steps" value="1" min="1" max="1000"></label>
      <button onclick="doAdvance()">Advance</button>
    </div>
    <div class="group">
      <button onclick="doActAdvance()">Act A+B &amp; Adv(1)</button>
      <button onclick="doRepeat()">Repeat N</button>
      <label>N: <input type="number" id="repeatN" value="20" min="1" max="200"></label>
    </div>
  </div>
  <canvas id="chart" width="840" height="360"></canvas>
  <div id="log"></div>

  <script>
    const hist = [];

    const sliderA = document.getElementById('aVal');
    const sliderB = document.getElementById('bVal');
    const aLabel = document.getElementById('aLabel');
    const bLabel = document.getElementById('bLabel');
    sliderA.oninput = () => aLabel.textContent = parseFloat(sliderA.value).toFixed(2);
    sliderB.oninput = () => bLabel.textContent = parseFloat(sliderB.value).toFixed(1);

    function show(s) {
      document.getElementById('state').textContent = 't=' + s.t + '  x=' + s.x.toFixed(4);
      hist.push({t: s.t, x: s.x});
      drawChart();
    }

    function log(msg) {
      const el = document.getElementById('log');
      el.textContent = msg + '\n' + el.textContent;
    }

    async function doReset() {
      await fetch('/reset', {method: 'POST'});
      log('POST /reset');
      hist.length = 0;
      await doObserve();
    }

    async function doObserve() {
      const r = await fetch('/observe');
      const s = await r.json();
      show(s);
      log('GET /observe  â†’  ' + JSON.stringify(s));
    }

    async function doAct(action) {
      const value = parseFloat(action === 'A' ? sliderA.value : sliderB.value);
      await fetch('/act', {method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({action, value})});
      log('POST /act  {' + action + ': ' + value + '}');
    }

    async function doAdvance() {
      const steps = parseInt(document.getElementById('steps').value);
      await fetch('/advance', {method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({steps})});
      log('POST /advance  {steps: ' + steps + '}');
      await doObserve();
    }

    async function doActAdvance() {
      await doAct('A');
      await doAct('B');
      await fetch('/advance', {method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({steps: 1})});
      await doObserve();
    }

    async function doRepeat() {
      const n = parseInt(document.getElementById('repeatN').value);
      for (let i = 0; i < n; i++) {
        await doAct('A');
        await doAct('B');
        await fetch('/advance', {method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({steps: 1})});
        const r = await fetch('/observe');
        const s = await r.json();
        show(s);
      }
      log('--- repeated ' + n + ' times ---');
    }

    function drawChart() {
      const c = document.getElementById('chart'), ctx = c.getContext('2d');
      const W = c.width, H = c.height, pad = 40;
      ctx.clearRect(0, 0, W, H);
      if (hist.length < 1) return;

      const ts = hist.map(p => p.t);
      const xs = hist.map(p => p.x);
      const tMin = Math.min(...ts), tMax = Math.max(...ts, tMin + 1);
      const xMin = Math.min(...xs, -1) - 0.5, xMax = Math.max(...xs, 1) + 0.5;
      const sx = (W - 2 * pad) / (tMax - tMin), sy = (H - 2 * pad) / (xMax - xMin);
      const px = t => pad + (t - tMin) * sx, py = v => H - pad - (v - xMin) * sy;

      // axes
      ctx.strokeStyle = '#ddd'; ctx.beginPath();
      ctx.moveTo(pad, pad); ctx.lineTo(pad, H - pad); ctx.lineTo(W - pad, H - pad); ctx.stroke();

      ctx.fillStyle = '#999'; ctx.font = '11px system-ui';
      ctx.fillText('t', W / 2, H - 6);
      ctx.save(); ctx.translate(10, H / 2); ctx.rotate(-Math.PI / 2); ctx.fillText('x', 0, 0); ctx.restore();

      // zero line
      if (xMin < 0 && xMax > 0) {
        ctx.strokeStyle = '#e0e0e0'; ctx.lineWidth = 1; ctx.setLineDash([4, 4]);
        ctx.beginPath(); ctx.moveTo(pad, py(0)); ctx.lineTo(W - pad, py(0)); ctx.stroke();
        ctx.setLineDash([]);
      }

      // x line
      ctx.strokeStyle = '#2563eb'; ctx.lineWidth = 2; ctx.beginPath();
      hist.forEach((p, i) => { const a = px(p.t), b = py(p.x); i ? ctx.lineTo(a, b) : ctx.moveTo(a, b); });
      ctx.stroke();
      ctx.fillStyle = '#2563eb';
      hist.forEach(p => { ctx.beginPath(); ctx.arc(px(p.t), py(p.x), 2.5, 0, Math.PI * 2); ctx.fill(); });

      // tick labels
      ctx.fillStyle = '#aaa'; ctx.font = '10px system-ui';
      const tStep = Math.max(1, Math.ceil((tMax - tMin) / 15));
      for (let tt = tMin; tt <= tMax; tt += tStep) {
        ctx.fillText(tt, px(tt) - 5, H - pad + 14);
      }
      const xStep = Math.max(0.5, Math.ceil((xMax - xMin) / 8 * 2) / 2);
      for (let xv = Math.ceil(xMin / xStep) * xStep; xv <= xMax; xv += xStep) {
        ctx.fillText(xv.toFixed(1), 2, py(xv) + 3);
      }
    }

    doReset();
  </script>
</body>
</html>
