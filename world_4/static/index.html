<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>World 4</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: system-ui, sans-serif; max-width: 860px; margin: 40px auto; padding: 0 20px; color: #1a1a1a; }
    h1 { font-size: 1.4em; margin-bottom: 16px; }
    #state { font-family: monospace; font-size: 1.3em; margin-bottom: 20px; color: #333; }
    .controls { display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 20px; }
    .group { border: 1px solid #ddd; border-radius: 6px; padding: 10px 14px; display: flex; align-items: center; gap: 8px; }
    button { padding: 6px 14px; border: 1px solid #aaa; border-radius: 4px; background: #f5f5f5; cursor: pointer; font-size: 0.9em; }
    button:hover { background: #e8e8e8; }
    input[type=number] { width: 60px; padding: 4px 6px; border: 1px solid #bbb; border-radius: 4px; }
    input[type=range] { width: 120px; }
    label { font-size: 0.9em; display: flex; align-items: center; gap: 6px; }
    canvas { border: 1px solid #e0e0e0; border-radius: 4px; display: block; margin-bottom: 10px; }
    #log { font-family: monospace; font-size: 0.8em; max-height: 160px; overflow-y: auto; border: 1px solid #eee; border-radius: 4px; padding: 8px; color: #555; white-space: pre; }
  </style>
</head>
<body>
  <h1>World 4</h1>
  <div id="state">--</div>
  <div class="controls">
    <div class="group">
      <button onclick="doReset()">Reset</button>
      <button onclick="doObserve()">Observe</button>
    </div>
    <div class="group">
      <label>A: <input type="range" id="aVal" min="-5" max="5" step="0.1" value="0">
      <span id="aLabel">0.0</span></label>
      <button onclick="doAct('A')">Act A</button>
    </div>
    <div class="group">
      <label>B: <input type="range" id="bVal" min="-5" max="5" step="0.1" value="0">
      <span id="bLabel">0.0</span></label>
      <button onclick="doAct('B')">Act B</button>
    </div>
    <div class="group">
      <label>Steps: <input type="number" id="steps" value="1" min="1" max="1000"></label>
      <button onclick="doAdvance()">Advance</button>
    </div>
  </div>
  <canvas id="chart" width="780" height="340"></canvas>
  <div id="log"></div>

  <script>
    const hist = [];
    let last = null;

    const sliderA = document.getElementById('aVal');
    const sliderB = document.getElementById('bVal');
    const aLabel = document.getElementById('aLabel');
    const bLabel = document.getElementById('bLabel');
    sliderA.oninput = () => aLabel.textContent = parseFloat(sliderA.value).toFixed(1);
    sliderB.oninput = () => bLabel.textContent = parseFloat(sliderB.value).toFixed(1);

    function show(s) {
      last = s;
      document.getElementById('state').textContent = 't=' + s.t + '  x=' + s.x.toFixed(4) + '  y=' + s.y.toFixed(4);
      hist.push({t: s.t, x: s.x, y: s.y});
      drawChart();
    }

    function log(msg) {
      const el = document.getElementById('log');
      el.textContent = msg + '\n' + el.textContent;
    }

    async function doReset() {
      await fetch('/reset', {method: 'POST'});
      log('POST /reset');
      hist.length = 0;
      await doObserve();
    }

    async function doObserve() {
      const r = await fetch('/observe');
      const s = await r.json();
      show(s);
      log('GET /observe  â†’  ' + JSON.stringify(s));
    }

    async function doAct(action) {
      const value = parseFloat(action === 'A' ? sliderA.value : sliderB.value);
      await fetch('/act', {method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({action, value})});
      log('POST /act  {' + action + ': ' + value + '}');
    }

    async function doAdvance() {
      const steps = parseInt(document.getElementById('steps').value);
      await fetch('/advance', {method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({steps})});
      log('POST /advance  {steps: ' + steps + '}');
      await doObserve();
    }

    function drawChart() {
      const c = document.getElementById('chart'), ctx = c.getContext('2d');
      const W = c.width, H = c.height, pad = 40;
      ctx.clearRect(0, 0, W, H);
      if (hist.length < 1) return;

      const ts = hist.map(p => p.t);
      const xs = hist.map(p => p.x);
      const ys = hist.map(p => p.y);
      const allV = [...xs, ...ys];
      const tMin = Math.min(...ts), tMax = Math.max(...ts, tMin + 1);
      const vMin = Math.min(...allV) - 2, vMax = Math.max(...allV) + 2;
      const sx = (W - 2 * pad) / (tMax - tMin), sy = (H - 2 * pad) / (vMax - vMin);
      const px = t => pad + (t - tMin) * sx, py = v => H - pad - (v - vMin) * sy;

      ctx.strokeStyle = '#ddd'; ctx.beginPath();
      ctx.moveTo(pad, pad); ctx.lineTo(pad, H - pad); ctx.lineTo(W - pad, H - pad); ctx.stroke();

      ctx.fillStyle = '#999'; ctx.font = '11px system-ui';
      ctx.fillText('t', W / 2, H - 6);
      ctx.save(); ctx.translate(10, H / 2); ctx.rotate(-Math.PI / 2); ctx.fillText('value', 0, 0); ctx.restore();

      // x line
      ctx.strokeStyle = '#2563eb'; ctx.lineWidth = 2; ctx.beginPath();
      hist.forEach((p, i) => { const a = px(p.t), b = py(p.x); i ? ctx.lineTo(a, b) : ctx.moveTo(a, b); });
      ctx.stroke();
      ctx.fillStyle = '#2563eb';
      hist.forEach(p => { ctx.beginPath(); ctx.arc(px(p.t), py(p.x), 3, 0, Math.PI * 2); ctx.fill(); });

      // y line
      ctx.strokeStyle = '#dc2626'; ctx.lineWidth = 2; ctx.beginPath();
      hist.forEach((p, i) => { const a = px(p.t), b = py(p.y); i ? ctx.lineTo(a, b) : ctx.moveTo(a, b); });
      ctx.stroke();
      ctx.fillStyle = '#dc2626';
      hist.forEach(p => { ctx.beginPath(); ctx.arc(px(p.t), py(p.y), 3, 0, Math.PI * 2); ctx.fill(); });

      // legend
      ctx.fillStyle = '#2563eb'; ctx.fillRect(W - pad - 60, pad + 5, 12, 12);
      ctx.fillStyle = '#333'; ctx.fillText('x', W - pad - 44, pad + 15);
      ctx.fillStyle = '#dc2626'; ctx.fillRect(W - pad - 60, pad + 22, 12, 12);
      ctx.fillStyle = '#333'; ctx.fillText('y', W - pad - 44, pad + 32);
    }

    doReset();
  </script>
</body>
</html>
