<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>World 2</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: system-ui, sans-serif; max-width: 820px; margin: 40px auto; padding: 0 20px; color: #1a1a1a; }
    h1 { font-size: 1.4em; margin-bottom: 16px; }
    #state { font-family: monospace; font-size: 1.3em; margin-bottom: 20px; color: #333; }
    .controls { display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 20px; }
    .group { border: 1px solid #ddd; border-radius: 6px; padding: 10px 14px; display: flex; align-items: center; gap: 8px; }
    button { padding: 6px 14px; border: 1px solid #aaa; border-radius: 4px; background: #f5f5f5; cursor: pointer; font-size: 0.9em; }
    button:hover { background: #e8e8e8; }
    input[type=number] { width: 60px; padding: 4px 6px; border: 1px solid #bbb; border-radius: 4px; }
    input[type=range] { width: 140px; }
    label { font-size: 0.9em; display: flex; align-items: center; gap: 6px; }
    canvas { border: 1px solid #e0e0e0; border-radius: 4px; display: block; margin-bottom: 10px; }
    #jar { margin-bottom: 16px; }
    #log { font-family: monospace; font-size: 0.8em; max-height: 160px; overflow-y: auto; border: 1px solid #eee; border-radius: 4px; padding: 8px; color: #555; white-space: pre; }
  </style>
</head>
<body>
  <h1>World 2</h1>
  <div id="state">--</div>
  <canvas id="jar" width="780" height="60"></canvas>
  <div class="controls">
    <div class="group">
      <button onclick="doReset()">Reset</button>
      <button onclick="doObserve()">Observe</button>
    </div>
    <div class="group">
      <label>A: <input type="range" id="aVal" min="-5" max="5" step="0.1" value="0">
      <span id="aLabel">0.0</span></label>
      <button onclick="doAct()">Act</button>
    </div>
    <div class="group">
      <label>Steps: <input type="number" id="steps" value="1" min="1" max="1000"></label>
      <button onclick="doAdvance()">Advance</button>
    </div>
  </div>
  <canvas id="chart" width="780" height="280"></canvas>
  <div id="log"></div>

  <script>
    const hist = [];
    let last = null;

    const slider = document.getElementById('aVal');
    const aLabel = document.getElementById('aLabel');
    slider.oninput = () => aLabel.textContent = parseFloat(slider.value).toFixed(1);

    function show(s) {
      last = s;
      document.getElementById('state').textContent = 't=' + s.t + '  x=' + s.x.toFixed(4);
      hist.push({t: s.t, x: s.x});
      drawJar(s.x);
      drawChart();
    }

    function log(msg) {
      const el = document.getElementById('log');
      el.textContent = msg + '\n' + el.textContent;
    }

    async function doReset() {
      await fetch('/reset', {method: 'POST'});
      log('POST /reset');
      hist.length = 0;
      await doObserve();
    }

    async function doObserve() {
      const r = await fetch('/observe');
      const s = await r.json();
      show(s);
      log('GET /observe  â†’  ' + JSON.stringify(s));
    }

    async function doAct() {
      const value = parseFloat(slider.value);
      await fetch('/act', {method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({action: 'A', value})});
      log('POST /act  {A: ' + value + '}');
    }

    async function doAdvance() {
      const steps = parseInt(document.getElementById('steps').value);
      await fetch('/advance', {method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({steps})});
      log('POST /advance  {steps: ' + steps + '}');
      await doObserve();
    }

    function drawJar(xVal) {
      const c = document.getElementById('jar'), ctx = c.getContext('2d');
      const W = c.width, H = c.height, pad = 40;
      const inner = W - 2 * pad;
      ctx.clearRect(0, 0, W, H);

      ctx.strokeStyle = '#888';
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.moveTo(pad, 10); ctx.lineTo(pad, H - 10);
      ctx.moveTo(pad, H - 10); ctx.lineTo(W - pad, H - 10);
      ctx.moveTo(W - pad, H - 10); ctx.lineTo(W - pad, 10);
      ctx.stroke();

      ctx.fillStyle = '#999'; ctx.font = '10px system-ui';
      ctx.textAlign = 'center';
      ctx.fillText('0', pad, H - 1);
      ctx.fillText('50', W - pad, H - 1);

      if (xVal != null) {
        const bx = pad + (xVal / 50) * inner;
        ctx.fillStyle = '#2563eb';
        ctx.beginPath();
        ctx.arc(bx, H / 2 - 2, 8, 0, Math.PI * 2);
        ctx.fill();
      }
    }

    function drawChart() {
      const c = document.getElementById('chart'), ctx = c.getContext('2d');
      const W = c.width, H = c.height, pad = 40;
      ctx.clearRect(0, 0, W, H);
      if (hist.length < 1) return;

      const ts = hist.map(p => p.t), xs = hist.map(p => p.x);
      const tMin = Math.min(...ts), tMax = Math.max(...ts, tMin + 1);
      const xMin = Math.min(...xs, 0) - 1, xMax = Math.max(...xs, 50) + 1;
      const sx = (W - 2 * pad) / (tMax - tMin), sy = (H - 2 * pad) / (xMax - xMin);
      const px = t => pad + (t - tMin) * sx, py = x => H - pad - (x - xMin) * sy;

      ctx.strokeStyle = '#ddd'; ctx.beginPath();
      ctx.moveTo(pad, pad); ctx.lineTo(pad, H - pad); ctx.lineTo(W - pad, H - pad); ctx.stroke();

      // wall lines
      ctx.strokeStyle = '#f0c0c0'; ctx.lineWidth = 1; ctx.setLineDash([4, 4]);
      ctx.beginPath(); ctx.moveTo(pad, py(0)); ctx.lineTo(W - pad, py(0)); ctx.stroke();
      ctx.beginPath(); ctx.moveTo(pad, py(50)); ctx.lineTo(W - pad, py(50)); ctx.stroke();
      ctx.setLineDash([]);

      ctx.fillStyle = '#999'; ctx.font = '11px system-ui';
      ctx.fillText('t', W / 2, H - 6);
      ctx.save(); ctx.translate(10, H / 2); ctx.rotate(-Math.PI / 2); ctx.fillText('x', 0, 0); ctx.restore();

      ctx.strokeStyle = '#2563eb'; ctx.lineWidth = 2; ctx.beginPath();
      hist.forEach((p, i) => { const a = px(p.t), b = py(p.x); i ? ctx.lineTo(a, b) : ctx.moveTo(a, b); });
      ctx.stroke();

      ctx.fillStyle = '#2563eb';
      hist.forEach(p => { ctx.beginPath(); ctx.arc(px(p.t), py(p.x), 3, 0, Math.PI * 2); ctx.fill(); });
    }

    doReset();
  </script>
</body>
</html>
